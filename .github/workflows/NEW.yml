name: FreeRDP

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 9999

    steps:
    - name: Download Required Files
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
        Invoke-WebRequest https://raw.githubusercontent.com/30dayscoding/rdp/main/wallpaper.jpg -OutFile wallpaper.jpg
        Invoke-WebRequest https://raw.githubusercontent.com/30dayscoding/rdp/main/wallpaper.bat -OutFile wallpaper.bat
        Invoke-WebRequest https://github.com/30dayscoding/rdp/raw/main/loop.ps1 -OutFile loop.ps1

    - name: Extract Ngrok
      run: Expand-Archive ngrok.zip

    - name: Authenticate Ngrok
      run: .\ngrok\ngrok.exe authtoken 37StOYMIU4pYVYkHJ7Wt7Ec4Yp7_Fkx4pyYiySnXydtyNRTZ

    - name: Enable RDP & Configure System
      run: |
        # Enable RDP
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
        
        # Create User
        net user administrator JohnTech1234 /add
        net localgroup administrators administrator /add
        net user administrator /active:yes
        
        # Start Audio Service (Safely)
        # We use 'try/catch' to ignore errors if it is already on
        try {
            Set-Service -Name Audiosrv -StartupType Automatic
            Start-Service -Name Audiosrv -ErrorAction Stop
        } catch {
            Write-Host "Audio service is already running or cannot be started. Continuing..."
        }

    - name: Start Ngrok Tunnel
      run: |
        # Clear old logs
        if (Test-Path ngrok.log) { Remove-Item ngrok.log }
        
        # Start Ngrok in the background and log output to a file
        Start-Process -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389 --log=stdout" -RedirectStandardOutput "ngrok.log" -WindowStyle Hidden

    - name: Wait for Tunnel
      run: Start-Sleep -Seconds 15

    - name: Get RDP Connection Info
      run: | 
        $url = ""
        try {
            $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels" -ErrorAction Stop
            $url = $response.tunnels[0].public_url
        } catch {
            Write-Host "Tunnel fetching failed. Retrying..."
            Start-Sleep -Seconds 5
            try {
                $response = Invoke-RestMethod -Uri "http://127.0.0.1:4040/api/tunnels" -ErrorAction Stop
                $url = $response.tunnels[0].public_url
            } catch {
                Write-Host "Still failed."
            }
        }

        if ($url) {
            Write-Host "=========================================="
            Write-Host "     SUCCESS! YOUR RDP INFO IS BELOW:     "
            Write-Host "=========================================="
            Write-Host "Computer/Address: $url"
            Write-Host "Username: administrator"
            Write-Host "Password: JohnTech1234"
            Write-Host "=========================================="
        } else {
            # IF THIS FAILS, WE PRINT THE LOGS TO SEE WHY
            Write-Error "Ngrok did not start correctly."
            Write-Host "====== NGROK ERROR LOGS ======"
            if (Test-Path ngrok.log) {
                Get-Content ngrok.log
            } else {
                Write-Host "No log file found."
            }
        }

    - name: Keep Alive (Loop)
      run: ./loop.ps1
